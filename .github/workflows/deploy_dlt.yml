name: Databricks Bundle Deploy (debug)

on:
  workflow_dispatch:

jobs:
  debug-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Show current working directory
        run: pwd

      - name: List .databricks directory recursively (show dotfiles)
        run: |
          ls -la
          echo "---- .databricks tree ----"
          if [ -d ".databricks" ]; then
            find .databricks -maxdepth 3 -type f -print -exec ls -la {} \;
          else
            echo ".databricks directory not found"
          fi

      - name: Print databricks.yml (if present)
        run: |
          path=".databricks/bundles/dev/databricks.yml"
          if [ -f "$path" ]; then
            echo "Found $path"
            sed -n '1,200p' "$path" || true
          else
            echo "$path not found"
            echo "Available files in .databricks/bundles/dev:"
            ls -la .databricks/bundles/dev || true
            exit 1
          fi

      - name: Run databricks bundle deploy
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          # Use explicit path to the directory that contains databricks.yml
          databricks bundle deploy --target dev -p .databricks/bundles/dev
