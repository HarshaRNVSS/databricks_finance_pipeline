name: Deploy Databricks Bundle

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout your repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Install latest Databricks CLI
      - name: Install Databricks CLI
        run: curl -fsSL https://raw.githubusercontent.com/databricks/cli/main/install.sh | bash


      # 3️⃣ Validate the bundle configuration
      - name: Validate Databricks Bundle
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: databricks bundle validate --target dev

      # 4️⃣ Deploy to Databricks
      - name: Deploy Databricks Bundle
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: databricks bundle deploy --target dev

      # 5️⃣ (Optional) Trigger a DLT run
      - name: Trigger DLT Pipeline Run
        env:
          DATABRICKS_HOST: ${{ secrets.DATABRICKS_HOST }}
          DATABRICKS_TOKEN: ${{ secrets.DATABRICKS_TOKEN }}
        run: |
          databricks bundle run --target dev --resource pipelines.silver_pipeline